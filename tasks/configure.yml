---
- name: "Copy configuration."
  become: true
  ansible.builtin.template:
    src: "configuration.py.j2"
    dest: "{{ netbox_path }}/netbox/netbox/configuration.py"
    owner: "{{ netbox_user }}"
    group: "{{ netbox_group }}"
    mode: "0440"
  register: "__netbox_copy_configuration"

- name: "Copy gunicorn configuration."
  become: true
  ansible.builtin.template:
    src: "gunicorn.py.j2"
    dest: "{{ netbox_path }}/gunicorn.py"
    owner: "{{ netbox_user }}"
    group: "{{ netbox_group }}"
    mode: "0440"
  register: "__netbox_copy_gunicorn_configuration"

- name: "Run upgrade script."
  become: true
  become_user: "{{ netbox_user }}"
  when: >
    __netbox_install_application.changed or
    __netbox_copy_configuration.changed or
    __netbox_copy_gunicorn_configuration.changed or
    netbox_force_upgrade_script
  environment:
    PYTHON: "{{ netbox_python_path }}"
  ansible.builtin.command:
    cmd: "{{ netbox_path }}/upgrade.sh"
  register: "__netbox_upgrade_script"
  # TODO: changed_when.
  # How do we detect a run, where something has changed besides DB migrations.
  changed_when: "'No migrations to apply.' not in __netbox_upgrade_script.stdout"
